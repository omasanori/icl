name: Test Package Building

on:
  workflow_dispatch:

jobs:
  test-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y rpm-build rpmdevtools sbcl libfixposix-devel gcc make grep

      - name: Setup rpmbuild directory
        run: rpmdev-setuptree

      - name: Create source tarball
        run: |
          VERSION=$(grep ':version' icl.asd | head -1 | sed 's/.*:version[[:space:]]*"\([^"]*\)".*/\1/')
          echo "Building version: $VERSION"
          cd ..
          tar czf ~/rpmbuild/SOURCES/icl-${VERSION}.tar.gz --transform "s,^icl,icl-${VERSION}," icl

      - name: Build RPM and SRPM
        run: |
          cp icl.spec ~/rpmbuild/SPECS/
          cd ~/rpmbuild/SPECS
          rpmbuild -ba icl.spec

      - name: List built packages
        run: |
          echo "Binary RPMs:"
          ls -lh ~/rpmbuild/RPMS/x86_64/ || true
          echo "Source RPMs:"
          ls -lh ~/rpmbuild/SRPMS/ || true

      - name: Test installation
        run: |
          dnf install -y ~/rpmbuild/RPMS/x86_64/*.rpm
          icl --version || icl -h || true

  test-deb:
    runs-on: ubuntu-latest
    container:
      image: debian:stable
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y debhelper devscripts sbcl libfixposix-dev gcc make

      - name: Build DEB packages (binary and source)
        run: dpkg-buildpackage -uc -us

      - name: List built packages
        run: |
          echo "Binary packages:"
          ls -lh ../*.deb 2>/dev/null || true
          echo "Source packages:"
          ls -lh ../*.dsc ../*.tar.* 2>/dev/null || true

      - name: Test installation
        run: |
          apt-get install -y ../*.deb
          icl --version || icl -h || true
